<!DOCTYPE html>
<html ng-app="myApp" ng-controller="appDetailController">
<head>
    <title>Decompile: {{ appName }}</title>

    <script src="/js/angular.min.js"></script>
    <!--<script src="/js/angular.sanitize.min.js"></script>-->
    <!--<script src="/js/angular.sanitize.min.js.map"></script>-->
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
    <link href="/css/test.css" rel="stylesheet">

</head>

<body>
<!-- Bootstrap core JavaScript -->
<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<div class="container">

    <br>
    <br>
    <div align="center">
        <a href="/"><img src="/img/icon_64.png"></a>
        <h1>Decompile: {{ appName }}</h1>
    </div>
    <br>

    <div align="center">

        <table class="card">
            <tr>
                <td><strong>Step</strong></td>
                <td><strong>Action</strong></td>
                <td><strong>Status</strong></td>
                <td><strong>Browse</strong></td>
            </tr>
            <tr>
                <td align="center">1</td>
                <td>
                    <button ng-click="copyApk()">Copy APK</button>
                </td>
                <td align="center">
                    {{ copy_apk_status | checkmark }}
                </td>
                <td align="center">
                    <a href={{copy_apk_url}} target="_blank">link</a>
                </td>
            </tr>
            <tr>
                <td align="center">2</td>
                <td>
                    <button ng-click="unzipApk()">Unzip APK</button>
                </td>
                <td align="center">
                    {{ unzip_apk_status | checkmark }}
                </td>
                <td align="center">
                    <a href={{unzip_apk_url}} target="_blank">link</a>
                </td>
            </tr>
            <tr>
                <td align="center">3</td>
                <td>
                    <button ng-click="dex2jar()">DEX to JAR</button>
                </td>
                <td align="center">
                    {{ dex2jar_status | checkmark }}
                </td>
                <td align="center">
                    <a href={{dex2jar_url}} target="_blank">link</a>
                </td>
            </tr>
            <tr>
                <td align="center">4.A</td>
                <td>
                    <button ng-click="startCfr()">Decompile with CFR 0.110</button>
                </td>
                <td align="center">
                    {{ cfr_thread }}
                    <button ng-show="cfr_show_button" ng-click="stopThread('cfr')">Stop</button>
                </td>
                <td align="center">
                    <a href={{cfr_url}} target="_blank">link</a>
                </td>
            </tr>
            <tr>
                <td align="center">4.B</td>
                <td>
                    <button ng-click="startJadx()">Decompile with JaDX 0.6.1</button>
                </td>
                <td align="center">
                    {{ jadx_thread }}
                    <button ng-show="jadx_show_button" ng-click="stopThread('jadx')">Stop</button>
                </td>
                <td align="center">
                    <a href={{jadx_url}} target="_blank">link</a>
                </td>
            </tr>
            <tr>
                <td align="center">4.C</td>
                <td>
                    <button ng-click="startFernFlower()">Decompile with FernFlower</button>
                </td>
                <td align="center">
                    {{ fern_thread }}
                    <button ng-show="fern_show_button" ng-click="stopThread('fern')">Stop</button>
                </td>
                <td align="center">
                    <a href={{fern_url}} target="_blank">link</a>
                </td>
            </tr>
        </table>
        <br>

        <table class="card">
            <tr>
                <td>
                    <input placeholder="Search" size="45" type="text" ng-model="search"> # {{ (myStream|filter:search).length }}
                    <button ng-click="refreshLog()"><span class="glyphicon glyphicon-refresh"></span></button>
                    <button ng-click="clearLog()"><span class="glyphicon glyphicon-remove"></span></button>
                    <br>
                </td>
            </tr>

            <tr ng-repeat="line in myStream | filter : search track by $index">
                <td style="padding: 2px 0;"> {{ line }} </td>
            </tr>
        </table>
    </div>


</div><!-- /card-container -->

<br>
<br>
<br>

<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" align="center">
    <p>
        &copy;
        <script>
			var d = new Date();
			document.write(d.getFullYear());
		</script>
        Nuvolect LLC -
        <a href="https://nuvolect.com/pentest_terms/" target="_blank">Terms</a>
        -
        <a href="https://nuvolect.com/privacy/" target="_blank">Privacy</a>
        -
        <a href="https://nuvolect.com/pentest_help/" target="_blank">Help</a>
    </p>
</div>

<script>

var app = angular.module('myApp', []);
app.controller('appDetailController', function($scope, $http, $parse, $interval, $timeout, $sce) {

    function getURLParameter(name) {
      return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
    }

    function getProcessState( state ){

        if( state == "null")
            return '-';
        if( state == "stopped")
            return '\u2713';

        return state;
    }

    function updateStatus( status ){

        $scope.copy_apk_status = status.copy_apk_status;
        $scope.copy_apk_url = status.copy_apk_url;
        $scope.unzip_apk_status = status.unzip_apk_status;
        $scope.unzip_apk_url = status.unzip_apk_url;
        $scope.dex2jar_status = status.dex2jar_status;
        $scope.dex2jar_url = status.dex2jar_url;

        $scope.cfr_thread  = getProcessState( status.cfr_thread);
        $scope.jadx_thread = getProcessState( status.jadx_thread);
        $scope.fern_thread = getProcessState( status.fern_thread);

        $scope.cfr_url  = status.cfr_url;
        $scope.jadx_url = status.jadx_url;
        $scope.fern_url = status.fern_url;

        $scope.cfr_show_button  = ( status.cfr_thread == "running")
        $scope.jadx_show_button = ( status.jadx_thread == "running")
        $scope.fern_show_button = ( status.fern_thread == "running")
    }

    $scope.stopThread = function(myMethod){

         $http.get("/connector/?cmd=pentest&test_id=stop_thread&method="+myMethod)
           .then(function (response) {

        });
    };

    $scope.packageName = getURLParameter('packageName');
    $scope.appName = getURLParameter('appName');

     $http.get("/connector/?cmd=pentest&test_id=decompile_init&package_name="+$scope.packageName)
       .then(function (response) {

        // Object is currently a string, convert it to JSON
        var status = $.parseJSON( response.data.status );

            updateStatus( status );

            $scope.myStream = [];// array of log items
     });

     $interval(function () {

         $http.get("/connector/?cmd=pentest&test_id=get_status&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            updateStatus( status );
         });

     }, 2000);

     $timeout( function() {

         $interval(function () {

             $scope.refreshLog();

         }, 2000);

     }, 1000);

     $scope.copyApk = function(){

         $http.get("/connector/?cmd=pentest&test_id=copy_apk&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.copy_apk_status = status.copy_apk_status;
            $scope.copy_apk_url    = status.copy_apk_url;
            $scope.myStream = $scope.myStream.concat(["Copy complete"]);
         });
     };
     $scope.unzipApk = function(){

         $http.get("/connector/?cmd=pentest&test_id=unzip_apk&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.unzip_apk_status = status.unzip_apk_status;
            $scope.unzip_apk_url    = status.unzip_apk_url;
            $scope.myStream = $scope.myStream.concat(["Unzip complete"]);
         });
     };
     $scope.dex2jar = function(){

         $http.get("/connector/?cmd=pentest&test_id=dex2jar&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.dex2jar_status = status.dex2jar_status;
            $scope.dex2jar_url    = status.dex2jar_url;
            $scope.myStream = $scope.myStream.concat(["DEX to JAR complete"]);
         });
     };
     $scope.refreshLog = function(){

         $http.get("/connector/?cmd=pentest&test_id=get_stream")
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var log = $.parseJSON( response.data.stream );
            var update = $scope.myStream.concat( log );
            $scope.myStream = update;
         });
     };
     $scope.clearLog = function(){

         $http.get("/connector/?cmd=pentest&test_id=clear_stream")
           .then(function (response) {

            $scope.myStream = [];
         });
     };
     $scope.startCfr = function(){

         $http.get("/connector/?cmd=pentest&test_id=jar2src&method=cfr&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.cfr_thread = status.cfr_thread;
            $scope.cfr_url    = status.cfr_url;
         });
     };
     $scope.startJadx = function(){

         $http.get("/connector/?cmd=pentest&test_id=jar2src&method=jadx&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.jadx_status = status.jadx_status;
            $scope.jadx_url    = status.jadx_url;
         });
     };
     $scope.startFernFlower = function(){

         $http.get("/connector/?cmd=pentest&test_id=jar2src&method=fern_flower&package_name="+$scope.packageName)
           .then(function (response) {

            // Object is currently a string, convert it to JSON
            var status = $.parseJSON( response.data.status );

            $scope.fern_status = status.fern_status;
            $scope.fern_url    = status.fern_url;
         });
     };
});

app.filter('checkmark', function() {
 return function(input) {
        return input ? '\u2713' : '-'; //'\u2718';
 };
});
app.filter('showStatus', function() {
 return function(x) {

        return '<span class="glyphicon glyphicon-search" aria-hidden="true"></span>';
 };
});
app.filter('showFlag', function() {
 return function(x) {

    if( x == 1)
        return "Set";
    if( x == 0)
        return "-";

    return "";
 };
});

</script>
</body>
</html>