package com.nuvolect.pentest.apk;

import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.widget.Toast;

import com.googlecode.dex2jar.Method;
import com.googlecode.dex2jar.ir.IrMethod;
import com.googlecode.dex2jar.reader.DexFileReader;
import com.googlecode.dex2jar.v3.Dex2jar;
import com.googlecode.dex2jar.v3.DexExceptionHandler;
import com.nuvolect.pentest.util.LogUtil;
import com.nuvolect.pentest.util.OmniFile;
import com.nuvolect.pentest.util.OmniHash;
import com.nuvolect.pentest.util.OmniZip;
import com.nuvolect.pentest.util.Util;
import com.nuvolect.pentest.webserver.connector.VolUtil;

import org.benf.cfr.reader.state.ClassFileSourceImpl;
import org.benf.cfr.reader.state.DCCommonState;
import org.benf.cfr.reader.util.getopt.GetOptParser;
import org.benf.cfr.reader.util.getopt.OptionsImpl;
import org.benf.cfr.reader.util.output.DumperFactoryImpl;
import org.jetbrains.java.decompiler.main.decompiler.ConsoleDecompiler;
import org.jetbrains.java.decompiler.main.decompiler.PrintStreamLogger;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.objectweb.asm.tree.MethodNode;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintStream;
import java.util.HashMap;
import java.util.Map;

import jadx.api.JadxDecompiler;
import jadx.core.utils.exceptions.JadxException;

import static com.nuvolect.pentest.util.OmniZip.unzipFile;

/**
 * Utilities to work with APK files.
 * A top level folder is created at CConst.APP_FOLDER_NAME
 * Sub-folders are created for each app to inspect, named with the package name
 * Sub-folders contain
 * 1. the APK.zip file,
 * 2. the expanded zip file and
 * 3. decompiled class files
 */
public class ApkUtil {

    private static String m_topFolderUrl = "";
    private static String m_topFolderFullPath;
    private static String m_appFolderFullPath;
    private static OmniFile m_appFolder;
    private static String m_appFolderUrl;
    private static String m_appZipFullPath;
    private static OmniFile m_dexFile;
    private static String m_dexFullPath;
    private static String m_jarFullPath;
    private static OmniFile m_jarFile;
    private static String m_srcCfrFolderPath;
    private static OmniFile m_srcCfrFolder;
    private static String m_srcJadxFolderPath;
    private static OmniFile m_srcJadxFolder;
    private static String m_srcFernFolderPath;
    private static OmniFile m_srcFernFolder;
    private static ProgressStream m_progessStream;

    //    SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);
    //    STACK_SIZE = Integer.valueOf(prefs.getString("thread_stack_size", String.valueOf(20 * 1024 * 1024)));
    //    IGNORE_LIBS = prefs.getBoolean("ignore_libraries", true);
    private static int STACK_SIZE = 20 * 1024 * 1024;

    private static Thread m_cfrThread = null;
    private static Thread m_jadxThread = null;
    private static Thread m_fernThread = null;
    private static String CFL_THREAD = "CFL jar to java thread";
    private static String JADX_THREAD = "JaDX jar to java thread";
    private static String FERN_THREAD = "FernFlower jar to java thread";

    public enum COMPILE_METHOD { cfr, jadx, fern_flower, simple_unzip};

    /**
     * Create a working folder for the app then create a sub-folder based on the package name.
     * @param ctx
     * @return
     */
    public static JSONObject init(Context ctx, String package_name) {

        m_progessStream = new ProgressStream();

        m_topFolderFullPath = Util.createAppPublicFolder();
        if (m_topFolderFullPath.isEmpty()) {
            Toast.makeText(ctx, "SDCARD folder creation error", Toast.LENGTH_LONG).show();
        } else {
            m_topFolderUrl = OmniHash.getHashedServerUrlFullPath(ctx,
                    VolUtil.sdcardVolumeId, m_topFolderFullPath);

            m_appFolderFullPath = m_topFolderFullPath + "/" + package_name;
            m_appFolder = new OmniFile(VolUtil.sdcardVolumeId, m_appFolderFullPath);
            if (!m_appFolder.exists()) {
                m_appFolder.mkdir();
            }
            m_appFolderUrl = OmniHash.getHashedServerUrlFullPath(ctx,
                    VolUtil.sdcardVolumeId, m_appFolderFullPath);

        }
        return getStatus(ctx, package_name);
    }

    public static JSONObject getStatus(Context ctx, String package_name) {

        boolean zipFileExists = false;
        boolean dexFileExists = false;
        boolean dex2jarFileExists = false;
        boolean cfrFolderExists = false;
        boolean jadxFolderExists = false;
        boolean fernFolderExists = false;
        JSONObject wrapper = new JSONObject();

        /**
         * Update status on tasks performed
         */
        m_appZipFullPath = m_appFolderFullPath+"/"+package_name+".apk.zip";
        OmniFile zipFile = new OmniFile(VolUtil.sdcardVolumeId, m_appZipFullPath);
        zipFileExists = zipFile.exists();

        m_dexFullPath = m_appFolderFullPath+"/classes.dex";
        m_dexFile = new OmniFile(VolUtil.sdcardVolumeId, m_dexFullPath);
        dexFileExists = m_dexFile.exists();

        m_jarFullPath = m_appFolderFullPath+"/"+package_name+".jar";
        m_jarFile = new OmniFile(VolUtil.sdcardVolumeId, m_jarFullPath);
        dex2jarFileExists = m_jarFile.exists();

        m_srcCfrFolderPath = m_appFolderFullPath+"/srcCfr";
        m_srcCfrFolder = new OmniFile(VolUtil.sdcardVolumeId, m_srcCfrFolderPath);
        cfrFolderExists = m_srcCfrFolder.exists();

        m_srcJadxFolderPath = m_appFolderFullPath+"/srcJadx";
        m_srcJadxFolder = new OmniFile(VolUtil.sdcardVolumeId, m_srcJadxFolderPath);
        jadxFolderExists = m_srcJadxFolder.exists();

        m_srcFernFolderPath = m_appFolderFullPath+"/srcFern";
        m_srcFernFolder = new OmniFile(VolUtil.sdcardVolumeId, m_srcFernFolderPath);
        fernFolderExists = m_srcFernFolder.exists();

        try {

            wrapper.put("copy_apk_status", zipFileExists ?1:0);
            wrapper.put("copy_apk_url", m_appFolderUrl);
            wrapper.put("unzip_apk_status", dexFileExists ?1:0);
            wrapper.put("unzip_apk_url", m_appFolderUrl);
            wrapper.put("dex2jar_status", dex2jarFileExists ?1:0);
            wrapper.put("dex2jar_url", m_appFolderUrl);

            if(cfrFolderExists){
                String url = OmniHash.getHashedServerUrlFullPath(ctx,
                        VolUtil.sdcardVolumeId, m_srcCfrFolderPath);
                wrapper.put("cfr_url", url);
            }
            else
                wrapper.put("cfr_url", m_appFolderUrl);

            if(jadxFolderExists){
                String url = OmniHash.getHashedServerUrlFullPath(ctx,
                        VolUtil.sdcardVolumeId, m_srcJadxFolderPath);
                wrapper.put("jadx_url", url);
            }
            else
                wrapper.put("jadx_url", m_appFolderUrl);

            if(fernFolderExists){
                String url = OmniHash.getHashedServerUrlFullPath(ctx,
                        VolUtil.sdcardVolumeId, m_srcFernFolderPath);
                wrapper.put("fern_url", url);
            }
            else
                wrapper.put("fern_url", m_appFolderUrl);

            wrapper.put("cfr_thread",  getThreadStatus( cfrFolderExists, m_cfrThread));
            wrapper.put("jadx_thread", getThreadStatus( jadxFolderExists, m_jadxThread));
            wrapper.put("fern_thread", getThreadStatus( fernFolderExists, m_fernThread));

        } catch (JSONException e) {
            e.printStackTrace();
        }

        return wrapper;
    }

    /**
     * Return the status of a compile process. The status can be one of three states:
     * running: compile process is running
     * stopped: comple process has stopped, folder exists
     * null: compile process is not running, folder does not exist
     *
     * @param folderExists
     * @param aThread
     * @return
     */
    private static String getThreadStatus(boolean folderExists, Thread aThread) {

        if( aThread != null && aThread.isAlive())
            return "running";

        if( folderExists)
            return "stopped";

        return "null";
    }


    /**
     * Copy the specific APK to working folder.
     * Return a link to the parent folder.
     * @param ctx
     * @return
     */
    public static JSONObject copyApk(Context ctx, String package_name) {

        JSONObject wrapper = new JSONObject();

        try {
            wrapper.put("copy_apk_status", 0);// 0==Start with failed file copy

            PackageManager pm = ctx.getPackageManager();
            ApplicationInfo applicationInfo = pm.getApplicationInfo( package_name, PackageManager.GET_META_DATA);

            java.io.File inputFile = new File( applicationInfo.publicSourceDir);
            InputStream inputStream = new FileInputStream( inputFile );

            if( m_appFolderFullPath == null)
                init( ctx, package_name);

            File outputFile = new File(m_appZipFullPath);
            OutputStream outputStream = new FileOutputStream( outputFile );
            Util.copyFile( inputStream, outputStream);

            wrapper.put("copy_apk_status", 1); // Change to success if we get here
            wrapper.put("copy_apk_url", m_appFolderUrl);

        } catch (PackageManager.NameNotFoundException | JSONException | IOException e) {
            LogUtil.logException(LogUtil.LogType.APK_UTIL, e);
            m_progessStream.putStream(e.toString());
        }

        return wrapper;
    }
    public static JSONObject unzipApk(Context ctx, String package_name) {

        boolean success = false;

        if( m_appFolderFullPath == null)
            init( ctx, package_name);

        JSONObject wrapper = new JSONObject();

        try {
            wrapper.put("unzip_apk_status", 0);

            OmniFile appZip = new OmniFile(VolUtil.sdcardVolumeId, m_appZipFullPath);
            if( appZip.exists() && appZip.isFile()){

                success = unzipFile(appZip, m_appFolder, null, null);
            }

            wrapper.put("unzip_apk_status", success?1:0);
            wrapper.put("unzip_apk_url", m_appFolderUrl);

        } catch (JSONException e) {
            e.printStackTrace();
        }

        return wrapper;
    }

    public static JSONObject dex2jar(Context ctx, String package_name) {

        // DEX 2 JAR CONFIGS
        boolean reuseReg = false; // reuse register while generate java .class file
        boolean topologicalSort1 = false; // same with --topological-sort/-ts
        boolean topologicalSort = false; // sort block by topological, that will generate more readable code
        boolean verbose = true; // show progress
        boolean debugInfo = false; // translate debug info
        boolean printIR = false; // print ir to System.out
        boolean optimizeSynchronized = true; // Optimise-synchronised

        if( m_appFolderFullPath == null)
            init( ctx, package_name);

        JSONObject wrapper = new JSONObject();

        File jarFile = new File(m_appFolderFullPath + "/" + package_name + ".jar");
        File dexFile = new File(m_dexFullPath);

        try {
            wrapper.put("dex2jar_status", 0);
            wrapper.put("dex2jar_url", m_appFolderUrl);

            if( m_dexFile.exists() && dexFile.isFile()){

                DexExceptionHandlerMod dexExceptionHandlerMod = new DexExceptionHandlerMod();

                DexFileReader reader = new DexFileReader( dexFile);
                Dex2jar dex2jar = Dex2jar
                        .from(reader)
                        .reUseReg(reuseReg)
                        .topoLogicalSort(topologicalSort || topologicalSort1)
                        .skipDebug(!debugInfo)
                        .optimizeSynchronized(optimizeSynchronized)
                        .printIR(printIR)
                        .verbose(verbose);
                dex2jar.setExceptionHandler(dexExceptionHandlerMod);
                dex2jar.to(jarFile);
                wrapper.put("dex2jar_status", 1);// Update to indicate success
            }

        } catch (JSONException | IOException e) {
            LogUtil.logException(LogUtil.LogType.APK_UTIL, e);
            m_progessStream.putStream(e.toString());
        }

        return wrapper;
    }

    public static JSONObject jar2src(Context ctx, final String package_name, String compile_method) {

        if( m_appFolderFullPath == null)
            init( ctx, package_name);

        JSONObject wrapper = new JSONObject();
        String url = "";
        String processKey = "undef";
        String processStatus = null;
        String urlKey = "";
        boolean success = false;

        COMPILE_METHOD compileMethod = COMPILE_METHOD.valueOf( compile_method);

        LogUtil.log(LogUtil.LogType.APK_UTIL, "compile method: "+compile_method);

        if (m_jarFile.exists() && m_jarFile.isFile()) {

            switch( compileMethod){

                case cfr: {

                    m_srcCfrFolder.mkdirs();

                    String[] args = {m_jarFile.getStdFile().toString(), "--outputdir",
                            m_srcCfrFolder.getStdFile().toString()};
                    GetOptParser getOptParser = new GetOptParser();

                    org.benf.cfr.reader.util.getopt.Options options = null;
                    try {
                        options = getOptParser.parse(args, OptionsImpl.getFactory());

                        if(!options.optionIsSet(OptionsImpl.HELP) && options.getOption(OptionsImpl.FILENAME) != null) {

                            Thread.UncaughtExceptionHandler uncaughtExceptionHandler = new Thread.UncaughtExceptionHandler() {
                                @Override
                                public void uncaughtException(Thread t, Throwable e) {

                                    LogUtil.log(LogUtil.LogType.APK_UTIL, "Uncaught exception: "+e.toString());
                                    m_progessStream.putStream("Uncaught exception: "+t.getName());
                                    m_progessStream.putStream("Uncaught exception: "+e.toString());
                                }
                            };

                            ThreadGroup group = new ThreadGroup(CFL_THREAD);
                            final org.benf.cfr.reader.util.getopt.Options finalOptions = options;
                            m_cfrThread = new Thread(group, new Runnable() {
                                @Override
                                public void run() {
                                    boolean javaError = false;
                                    try {

                                        m_progessStream.putStream( "CFR starting");
                                        ClassFileSourceImpl classFileSource = new ClassFileSourceImpl(finalOptions);
                                        final DCCommonState dcCommonState = new DCCommonState(finalOptions, classFileSource);
                                        final String path = finalOptions.getOption(OptionsImpl.FILENAME);
                                        DumperFactoryImpl dumperFactory = new DumperFactoryImpl();
                                        org.benf.cfr.reader.Main.doJar( dcCommonState, path, dumperFactory);
                                        m_progessStream.putStream( "CFR doJar complete");

                                    } catch (Exception | StackOverflowError e) {
                                        m_progessStream.putStream(e.toString());
                                        javaError = true;
                                    }
                                    if( javaError)
                                        m_progessStream.putStream( "CFR starting XML extractor skipped on error");
                                    else{
                                        m_progessStream.putStream( "CFR starting XML extractor");
                                        startXMLExtractor(!javaError);
                                        m_progessStream.putStream( "CFR XML extractor complete");
                                    }
                                    m_progessStream.putStream( "CFR complete");
                                }
                            }, CFL_THREAD, STACK_SIZE);

                            m_cfrThread.setPriority(Thread.MAX_PRIORITY);
                            m_cfrThread.setUncaughtExceptionHandler(uncaughtExceptionHandler);
                            m_cfrThread.start();

                        } else {
                            m_progessStream.putStream("exit_process_on_error");
                        }
                    } catch (Exception | StackOverflowError e) {
                        e.printStackTrace();
                    }

                    processKey = "cfr_thread";
                    processStatus = getThreadStatus( true, m_cfrThread);
                    urlKey = "cfr_url";
                    url = OmniHash.getHashedServerUrlFullPath(ctx,
                            VolUtil.sdcardVolumeId, m_srcCfrFolderPath);

                    LogUtil.log(LogUtil.LogType.APK_UTIL, compile_method+" complete");
                    break;
                }

                case jadx: {

                    Thread.UncaughtExceptionHandler uncaughtExceptionHandler = new Thread.UncaughtExceptionHandler() {
                        @Override
                        public void uncaughtException(Thread t, Throwable e) {

                            LogUtil.log(LogUtil.LogType.APK_UTIL, "Uncaught exception: "+e.toString());
                            m_progessStream.putStream("Uncaught exception: "+t.getName());
                            m_progessStream.putStream("Uncaught exception: "+e.toString());
                        }
                    };

                    ThreadGroup group = new ThreadGroup(CFL_THREAD);
                    m_jadxThread = new Thread(group, new Runnable() {
                        @Override
                        public void run() {

                            m_srcJadxFolder.mkdirs();
                            m_progessStream.putStream("JaDX starting");
                            JadxDecompiler jadx = new JadxDecompiler();
                            jadx.setOutputDir(m_srcJadxFolder.getStdFile());
                            try {
                                m_progessStream.putStream("JaDX loadFile start");
                                jadx.loadFile(m_dexFile.getStdFile());
                                m_progessStream.putStream("JaDX loadFile complete");
                            } catch (JadxException e) {
                                LogUtil.logException(LogUtil.LogType.APK_UTIL, e);
                                m_progessStream.putStream(e.toString());
                            }
                            m_progessStream.putStream("JaDX saveSources start");
                            jadx.saveSources();
                            m_progessStream.putStream("JaDX saveSources complete");

                        }
                    }, JADX_THREAD, STACK_SIZE);

                    m_jadxThread.setPriority(Thread.MAX_PRIORITY);
                    m_jadxThread.setUncaughtExceptionHandler(uncaughtExceptionHandler);
                    m_jadxThread.start();


                    processKey = "jadx_thread";
                    processStatus = getThreadStatus( true, m_jadxThread);
                    urlKey = "jadx_url";
                    url = OmniHash.getHashedServerUrlFullPath(ctx,
                            VolUtil.sdcardVolumeId, m_srcJadxFolderPath);

                    break;
                }

                case fern_flower: {// https://github.com/fesh0r/fernflower

                    m_srcFernFolder.mkdirs();

                    Thread.UncaughtExceptionHandler uncaughtExceptionHandler = new Thread.UncaughtExceptionHandler() {
                        @Override
                        public void uncaughtException(Thread t, Throwable e) {

                            LogUtil.log(LogUtil.LogType.APK_UTIL, "Uncaught exception: "+e.toString());
                            m_progessStream.putStream("Uncaught exception: "+t.getName());
                            m_progessStream.putStream("Uncaught exception: "+e.toString());
                        }
                    };

                    ThreadGroup group = new ThreadGroup(CFL_THREAD);
                    m_fernThread = new Thread(group, new Runnable() {
                        @Override
                        public void run() {

                            m_progessStream.putStream( "FernFlower starting");
                            PrintStream printStream = new PrintStream( m_progessStream);
                            System.setErr(printStream);
                            System.setOut(printStream);
                            PrintStreamLogger logger = new PrintStreamLogger(printStream);

                            final Map<String, Object> mapOptions = new HashMap<>();
                            File javaOutputDir = m_srcFernFolder.getStdFile();
                            ConsoleDecompiler decompiler = new ConsoleDecompiler(javaOutputDir, mapOptions, logger);
                            File jarInputFile = m_jarFile.getStdFile();
                            decompiler.addSpace(jarInputFile, true);

                            m_progessStream.putStream( "FernFlower decompiler.addSpace complete");
                            decompiler.decompileContext();
                            m_progessStream.putStream( "FernFlower decompiler.decompileContext complete");

                            OmniFile decompiledJarFile = new OmniFile(
                                    VolUtil.sdcardVolumeId, javaOutputDir + "/" + package_name + ".jar");
                            boolean success = OmniZip.unzipFile(decompiledJarFile, m_srcFernFolder, null, null);

                            if( success)
                                m_progessStream.putStream( "FernFlower decompiler.unzip complete");
                            else
                                m_progessStream.putStream( "FernFlower decompiler.unzip failed");

                            m_progessStream.putStream( "FernFlower complete");
                        }
                    }, FERN_THREAD, STACK_SIZE);

                    m_fernThread.setPriority(Thread.MAX_PRIORITY);
                    m_fernThread.setUncaughtExceptionHandler(uncaughtExceptionHandler);
                    m_fernThread.start();

                    processKey = "fern_thread";
                    processStatus = getThreadStatus( true, m_fernThread);
                    urlKey = "fern_url";
                    url = OmniHash.getHashedServerUrlFullPath(ctx,
                            VolUtil.sdcardVolumeId, m_srcFernFolderPath);

                    break;
                }
                case simple_unzip: {

                    // Simply unzip the jar file
                    success = OmniZip.unzipFile(m_jarFile, m_srcCfrFolder, null, null);
                    break;
                }
                default:
                    LogUtil.log(LogUtil.LogType.APK_UTIL, "unknown compile method: "+compile_method);
            }
        }


        try {
            wrapper.put("url", m_appFolderUrl);
            wrapper.put(processKey, processStatus);
            wrapper.put( urlKey, url);

        } catch (JSONException e) {
            e.printStackTrace();
        }

        return wrapper;
    }

    private static void startXMLExtractor(boolean b) {

    }

    public static JSONObject stopThread(String compile_method){

        COMPILE_METHOD compileMethod = COMPILE_METHOD.valueOf( compile_method);
        boolean stop = false;

        switch( compileMethod ){

            case cfr:
                if( m_cfrThread != null){
                    m_cfrThread.interrupt();
                    stop = true;
                }
                break;
            case jadx:
                if( m_jadxThread != null){
                    m_jadxThread.interrupt();
                    stop = true;
                }
                break;
            case fern_flower:
                break;
            case simple_unzip:
                break;
        }
        JSONObject status = new JSONObject();
        try {
            status.put("stop", stop?1:0);
        } catch (JSONException e) {
            e.printStackTrace();
        }
        return status;
    }

    private static class DexExceptionHandlerMod implements DexExceptionHandler {
        @Override
        public void handleFileException(Exception e) {
            LogUtil.logException(LogUtil.LogType.APK_UTIL, "Dex2Jar Exception", e);
        }

        @Override
        public void handleMethodTranslateException(Method method, IrMethod irMethod, MethodNode methodNode, Exception e) {
            LogUtil.logException(LogUtil.LogType.APK_UTIL, "Dex2Jar Exception", e);
        }
    }

    public static void clearStream() {

        m_progessStream.init();
    }

    public static JSONArray getStream() {

        return m_progessStream.getStream();
    }

}
